function GreenLight(){var e=[];if(0==greenLight){for(j=1;j<perkListLengths.length;j++)for(k=0;k<perkListLengths[j];k++)e.push({stringID:String(j)+"_"+String(k),value:2});greenLight=!0,this.postMessage({bonusPerks:e})}}function indexOfPerk(e,t){let r=t.length;for(let l=0;l<r;l++)if(e.k==t[l].k&&e.j==t[l].j)return l;return-1}function checkLockbyID(e,t){for(let r=0;r<lock[t].length;r++)if(e.id==lock[t][r])return!0;return!1}function search(t,r){var l=[],o=[],n=[0,0,0,0,0,0],p=[],f=[],s=[],m=[!1,!1,!1];filtSet=[];var n=[0,0,0,0,0,0],g=[0,0,0,0,0],S=0,L=0,u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],w=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];tempperk=[];var y=iweapon.length;for(i=0;i<y;i++)p.push(iweapon[i].length);var C=iarmor.length;for(i=0;i<C;i++)f.push(iarmor[i].length);for(i=0;i<C;i++)o.push([]),m.push(!1);var T=t.length;for(j=0;j<y;j++)for(k=0;k<p[j];k++)127==iweapon[j][k].id&&l.push({e:j,f:k});for(j=0;j<C;j++)for(k=0;k<f[j];k++)127==iarmor[j][k].id&&o[j].push(k);for(h=0;h<T;h++){for(j=0;j<y;j++)for(k=0;k<p[j];k++)iweapon[j][k].perk.j==t[h].j&&iweapon[j][k].perk.k==t[h].k&&l.push({e:j,f:k});for(j=0;j<C;j++)for(k=0;k<f[j];k++)iarmor[j][k].perk.j==t[h].j&&iarmor[j][k].perk.k==t[h].k&&o[j].push(k)}for(let e=0;e<lock.length;e++)if(1==lockBool[e])if(0==e){l.splice(0);for(let e=0;e<lock[0].length;e++)for(k=0;k<p[lock[0][e]];k++)l.push({e:lock[0][e],f:k})}else if(1==e)for(l.splice(0),j=0;j<y;j++)for(k=0;k<p[j];k++)checkLockbyID(iweapon[j][k],1)&&l.push({e:j,f:k});else if(e>1)for(o[e-2].splice(0),k=0;k<f[e-2];k++)checkLockbyID(iarmor[e-2][k],e)&&o[e-2].push(k);if(lockBool[0]&&lockBool[1]){l.splice(0);for(let e=0;e<lock[0].length;e++)for(let t=0;t<p[lock[0][e]];t++)checkLockbyID(iweapon[lock[0][e]][t],1)&&l.push({e:lock[0][e],f:t})}r.slice();var x=l.length;for(i=0;i<C;i++)s.push(o[i].length);for(i=0;i<r.length;i++)L+=r[i];for(S=12-L,i=0;i<T;i++)n[t[i].j]+=r[i];for(n[5]>0&&(n[5]--,S++),i=0;i<r.length;i++)tempperk.push(r[i]);for(this.console.time("search"),S>11&&GreenLight(),e=0;e<x;e++){for(g[4]=S,h=0;h<T;h++){if(iweapon[l[e].e][l[e].f].perk.k==t[h].k&&iweapon[l[e].e][l[e].f].perk.j==t[h].j){n[t[h].j]>0&&tempperk[h]>0&&S++,n[t[h].j]--,tempperk[h]--,w[4]=t[h].j,u[4]=h;break}w[4]=0,u[4]=20}if(legendaryWeapon||(n[iweapon[l[e].e][l[e].f].cell[0]]>0&&S++,n[iweapon[l[e].e][l[e].f].cell[0]]--,n[iweapon[l[e].e][l[e].f].cell[1]]>0&&S++,n[iweapon[l[e].e][l[e].f].cell[1]]--),legendaryWeapon&&(S+=2),0==greenLight&&S>11&&GreenLight(),S>3)for(a=0;a<s[0];a++){for(g[0]=S,h=0;h<T;h++){if(iarmor[0][o[0][a]].perk.k==t[h].k&&iarmor[0][o[0][a]].perk.j==t[h].j){n[t[h].j]>0&&tempperk[h]>0&&S++,n[t[h].j]--,tempperk[h]--,w[0]=t[h].j,u[0]=h;break}w[0]=0,u[0]=20}if(n[iarmor[0][o[0][a]].cell]>0&&S++,n[iarmor[0][o[0][a]].cell]--,0==greenLight&&S>11&&GreenLight(),S>5)for(b=0;b<s[1];b++){for(g[1]=S,h=0;h<T;h++){if(iarmor[1][o[1][b]].perk.k==t[h].k&&iarmor[1][o[1][b]].perk.j==t[h].j){n[t[h].j]>0&&tempperk[h]>0&&S++,n[t[h].j]--,tempperk[h]--,w[1]=t[h].j,u[1]=h;break}w[1]=0,u[1]=20}if(n[iarmor[1][o[1][b]].cell]>0&&S++,n[iarmor[1][o[1][b]].cell]--,0==greenLight&&S>11&&GreenLight(),S>7)for(g[2]=S,c=0;c<s[2];c++){for(h=0;h<T;h++){if(iarmor[2][o[2][c]].perk.k==t[h].k&&iarmor[2][o[2][c]].perk.j==t[h].j){n[t[h].j]>0&&tempperk[h]>0&&S++,n[t[h].j]--,tempperk[h]--,w[2]=t[h].j,u[2]=h;break}w[2]=0,u[2]=20}if(n[iarmor[2][o[2][c]].cell]>0&&S++,n[iarmor[2][o[2][c]].cell]--,S>9)for(g[3]=S,d=0;d<s[3];d++){for(h=0;h<T;h++){if(iarmor[3][o[3][d]].perk.k==t[h].k&&iarmor[3][o[3][d]].perk.j==t[h].j){n[t[h].j]>0&&tempperk[h]>0&&S++,n[t[h].j]--,tempperk[h]--,w[3]=t[h].j,u[3]=h;break}w[3]=0,u[3]=20}n[iarmor[3][o[3][d]].cell]>0&&S++,n[iarmor[3][o[3][d]].cell]--,S>11&&(filtSet.push([o[0][a],o[1][b],o[2][c],o[3][d],l[e].e,l[e].f]),0),S=g[3],0!=w[3]&&n[w[3]]++,n[iarmor[3][o[3][d]].cell]++,20!=u[3]&&tempperk[u[3]]++}S=g[2],0!=w[2]&&n[w[2]]++,n[iarmor[2][o[2][c]].cell]++,20!=u[2]&&tempperk[u[2]]++}S=g[1],0!=w[1]&&n[w[1]]++,n[iarmor[1][o[1][b]].cell]++,20!=u[1]&&tempperk[u[1]]++}S=g[0],0!=w[0]&&n[w[0]]++,n[iarmor[0][o[0][a]].cell]++,20!=u[0]&&tempperk[u[0]]++}S=g[4],0!=w[4]&&n[w[4]]++,legendaryWeapon||(n[iweapon[l[e].e][l[e].f].cell[0]]++,n[iweapon[l[e].e][l[e].f].cell[1]]++),20!=u[4]&&tempperk[u[4]]++}filtSet=filtSet.sort(sortMatrix),this.console.timeEnd("search");var P,v=[],W=[],M=[],B=[],R=filtSet.length,D=[],E=C+3,I=perkListLengths.length;for(i=0;i<E;i++)D.push(!1),W.push(0);for(i=0;i<I;i++)v.push(0);for(i=0;i<T;i++)tempperk[i]=r[i];if(0==greenLight){for(j=1;j<perkListLengths.length;j++)for(k=0;k<perkListLengths[j];k++)M.push({j:j,k:k,value:0});for(let e=0;e<R;e++){for(filtSetCells.push([]),B=[],P=[],j=0;j<E;j++)filtSetCells[e].push({j:0,k:0}),D[j]=!1,W[j]=0;for(h=0;h<T;h++)tempperk[h]=r[h];for(h=0;h<T;h++)for(iweapon[filtSet[e][C]][filtSet[e][C+1]].perk.k==t[h].k&&iweapon[filtSet[e][C]][filtSet[e][C+1]].perk.j==t[h].j&&tempperk[h]--,j=0;j<C;j++)iarmor[j][filtSet[e][j]].perk.k==t[h].k&&iarmor[j][filtSet[e][j]].perk.j==t[h].j&&tempperk[h]--;for(h=0;h<T;h++){for(j=0;j<C;j++)iarmor[j][filtSet[e][j]].cell==t[h].j&&tempperk[h]>0&&0==D[j]&&(filtSetCells[e][j].j=t[h].j,filtSetCells[e][j].k=t[h].k,D[j]=!0,tempperk[h]--);5==t[h].j&&tempperk[h]>0&&0==D[C+2]&&(filtSetCells[e][C+2].j=t[h].j,filtSetCells[e][C+2].k=t[h].k,D[C+2]=!0,tempperk[h]--),legendaryWeapon?(tempperk[h]>0&&0==D[C]&&(filtSetCells[e][C].j=t[h].j,filtSetCells[e][C].k=t[h].k,D[C]=!0,tempperk[h]--),tempperk[h]>0&&0==D[C+1]&&(filtSetCells[e][C+1].j=t[h].j,filtSetCells[e][C+1].k=t[h].k,D[C+1]=!0,tempperk[h]--)):(iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]==t[h].j&&tempperk[h]>0&&0==D[C]&&(filtSetCells[e][C].j=t[h].j,filtSetCells[e][C].k=t[h].k,D[C]=!0,tempperk[h]--),iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]==t[h].j&&tempperk[h]>0&&0==D[C+1]&&(filtSetCells[e][C+1].j=t[h].j,filtSetCells[e][C+1].k=t[h].k,D[C+1]=!0,tempperk[h]--))}for(j=0;j<C;j++)0==D[j]&&(W[iarmor[j][filtSet[e][j]].cell]++,v[iarmor[j][filtSet[e][j]].cell]<W[iarmor[j][filtSet[e][j]].cell]&&(v[iarmor[j][filtSet[e][j]].cell]=W[iarmor[j][filtSet[e][j]].cell]));if(legendaryWeapon){if(0==D[C+1]&&0==D[C])for(let e=1;e<perkListLengths.length;e++)W[e]+=2,v[e]<W[e]&&(v[e]=W[e]);else if(0==D[C+1]||0==D[C])for(let e=1;e<perkListLengths.length;e++)W[e]++,v[e]<W[e]&&(v[e]=W[e])}else 0==D[C]&&(W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]]++,v[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]]<W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]]&&(v[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]]=W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]])),0==D[C+1]&&(W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]]++,v[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]]<W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]]&&(v[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]]=W[iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]]));for(0==D[C+2]&&(W[5]++,W[5]>v[5]&&(v[5]=W[5])),j=0;j<C;j++)if(127==iarmor[j][filtSet[e][j]].id)for(k=0;k<f[j];k++)iarmor[j][k].cell==iarmor[j][filtSet[e][j]].cell&&0!=iarmor[j][k].perk.j&&0!=iarmor[j][k].perk.k&&B.push([iarmor[j][k].perk.j,iarmor[j][k].perk.k,j]);else B.push([iarmor[j][filtSet[e][j]].perk.j,iarmor[j][filtSet[e][j]].perk.k,j]);if(127==iweapon[filtSet[e][C]][filtSet[e][C+1]].id)for(j=0;j<y;j++)for(k=0;k<p[j];k++)(iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]==iweapon[j][k].cell[0]&&iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]==iweapon[j][k].cell[1]||iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[1]==iweapon[j][k].cell[0]&&iweapon[filtSet[e][C]][filtSet[e][C+1]].cell[0]==iweapon[j][k].cell[1])&&0!=iweapon[j][k].perk.j&&0!=iweapon[j][k].perk.k&&B.push([iweapon[j][k].perk.j,iweapon[j][k].perk.k,5]);else B.push([iweapon[filtSet[e][C]][filtSet[e][C+1]].perk.j,iweapon[filtSet[e][C]][filtSet[e][C+1]].perk.k,5]);B.sort(sortMatrix);let l=B.length,i=B.length-1;if(void 0!=B[0]){let e=-1;for(j=0;j<l;j++)if(j<i&&B[j][1]==B[j+1][1]&&B[j][0]==B[j+1][0]&&B[j+1][2]!=B[j][2]?(P.push({j:B[j][0],k:B[j][1],value:2}),j++,e++):(P.push({j:B[j][0],k:B[j][1],value:1}),P[++e].value+=W[P[e].j]),0!=P[e].j&&0!=P[e].k){let t=indexOfPerk(P[e],M);M[t].value<P[e].value&&(M[t].value=P[e].value)}}}var F=[];let e=0;for(M.length;e<M.length;e++)M[e].value<v[M[e].j]&&(M[e].value=v[M[e].j]),F.push({stringID:String(M[e].j)+"_"+String(M[e].k),value:M[e].value});this.postMessage({bonusPerks:F})}}function ExpandfiltSetelem(e,t){let r,l=[],i=e.length;if(t==armorTypeLength)for(let t=0;t<i;t++)for(let i=0;i<weaponTypeLength;i++)for(let h=0;h<weaponLength[i];h++)(iweapon[i][h].cell[0]==iweapon[e[t][armorTypeLength]][e[t][armorTypeLength+1]].cell[0]&&iweapon[i][h].cell[1]==iweapon[e[t][armorTypeLength]][e[t][armorTypeLength+1]].cell[1]||iweapon[i][h].cell[1]==iweapon[e[t][armorTypeLength]][e[t][armorTypeLength+1]].cell[0]&&iweapon[i][h].cell[0]==iweapon[e[t][armorTypeLength]][e[t][armorTypeLength+1]].cell[1])&&127!=iweapon[i][h].id&&((r=e[t].slice())[armorTypeLength]=i,r[armorTypeLength+1]=h,l.push(r));else for(let h=0;h<i;h++)for(let i=0;i<armorLength[t];i++)iarmor[t][e[h][t]].cell==iarmor[t][i].cell&&127!=iarmor[t][i].id&&((r=e[h].slice())[t]=i,l.push(r));return l}function ExpandRecursivefiltSetelem(e,t){let r=t.length,l=ExpandfiltSetelem(e,t[0]);for(let e=1;e<r;e++)l=ExpandfiltSetelem(l,t[e]);return l}function processFiltSetelem(e){let t=[],r=[],l=!0;if(1==greenLight){for(filtSetCells.push([]),tempbonusPerkMat=[],tempbonusPerk=[],j=0;j<setWidth;j++)filtSetCells[e].push({j:0,k:0}),t[j]=!1;for(h=0;h<indexPerkLength;h++)tempperk[h]=indexPerkRank[h];for(h=0;h<indexPerkLength;h++)for(iweapon[filtSet[e][armorTypeLength]][filtSet[e][armorTypeLength+1]].perk.k==indexPerk[h].k&&iweapon[filtSet[e][armorTypeLength]][filtSet[e][armorTypeLength+1]].perk.j==indexPerk[h].j&&tempperk[h]--,j=0;j<armorTypeLength;j++)iarmor[j][filtSet[e][j]].perk.k==indexPerk[h].k&&iarmor[j][filtSet[e][j]].perk.j==indexPerk[h].j&&tempperk[h]--;for(h=0;h<indexPerkLength;h++){for(j=0;j<armorTypeLength;j++)iarmor[j][filtSet[e][j]].cell==indexPerk[h].j&&tempperk[h]>0&&0==t[j]&&(filtSetCells[e][j].j=indexPerk[h].j,filtSetCells[e][j].k=indexPerk[h].k,t[j]=!0,tempperk[h]--);5==indexPerk[h].j&&tempperk[h]>0&&0==t[armorTypeLength+2]&&(filtSetCells[e][armorTypeLength+2].j=indexPerk[h].j,filtSetCells[e][armorTypeLength+2].k=indexPerk[h].k,t[armorTypeLength+2]=!0,tempperk[h]--),legendaryWeapon?(tempperk[h]>0&&0==t[armorTypeLength]&&(filtSetCells[e][armorTypeLength].j=indexPerk[h].j,filtSetCells[e][armorTypeLength].k=indexPerk[h].k,t[armorTypeLength]=!0),tempperk[h]--,tempperk[h]>0&&0==t[armorTypeLength+1]&&(filtSetCells[e][armorTypeLength+1].j=indexPerk[h].j,filtSetCells[e][armorTypeLength+1].k=indexPerk[h].k,t[armorTypeLength+1]=!0,tempperk[h]--)):(iweapon[filtSet[e][armorTypeLength]][filtSet[e][armorTypeLength+1]].cell[0]==indexPerk[h].j&&tempperk[h]>0&&0==t[armorTypeLength]&&(filtSetCells[e][armorTypeLength].j=indexPerk[h].j,filtSetCells[e][armorTypeLength].k=indexPerk[h].k,t[armorTypeLength]=!0,tempperk[h]--),iweapon[filtSet[e][armorTypeLength]][filtSet[e][armorTypeLength+1]].cell[1]==indexPerk[h].j&&tempperk[h]>0&&0==t[armorTypeLength+1]&&(filtSetCells[e][armorTypeLength+1].j=indexPerk[h].j,filtSetCells[e][armorTypeLength+1].k=indexPerk[h].k,t[armorTypeLength+1]=!0,tempperk[h]--))}}for(let t=0;t<armorTypeLength;t++)127==iarmor[t][filtSet[e][t]].id&&(l=!1,r.push(t));return 127==iweapon[filtSet[e][armorTypeLength]][filtSet[e][armorTypeLength+1]].id&&(l=!1,r.push(armorTypeLength)),saveSet=0==l?{id:ExpandRecursivefiltSetelem([filtSet[e]],r),cell:filtSetCells[e]}:{id:[filtSet[e]],cell:filtSetCells[e]},saveSet.id.length>1&&void 0!=saveSet.id[0][0]&&(saveSet.id=saveSet.id.sort(sortFunction)),r.splice(0),l=!0,saveSet}var greenLight=!1,filtSetCells=[],filtSet=[];const sortMatrix=(e,t)=>{for(let r=0;r<e.length;++r){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return 0};var lockBool=[],lock=[];const sortFunction=(e,t)=>{let r=e.length;for(let l=0;l<r;l++)return e[l]<t[l]?-1:1;return 0};var indexPerk,indexPerkRank,iarmor,iweapon,perkListLengths,indexPerkLength,setWidth,armorTypeLength,weaponTypeLength,legendaryWeapon=!1,filtSetCount=0,filtSetLength=0,cacheSet=[],cacheSetCount=0,cacheSetLength=0,setCount=0,weaponLength=[],armorLength=[];this.onmessage=function(e){if(void 0!=e.data.indexPerk){for(indexPerk=e.data.indexPerk,indexPerkRank=e.data.indexPerkRank,indexPerkLength=indexPerk.length,legendaryWeapon=e.data.legendaryWeapon,lock=e.data.lock,iarmor=e.data.iarmor,iweapon=e.data.iweapon,perkListLengths=e.data.perkListLengths,setWidth=iarmor.length+3,armorTypeLength=iarmor.length,weaponTypeLength=iweapon.length,i=0;i<weaponTypeLength;i++)weaponLength.push(iweapon[i].length);for(i=0;i<armorTypeLength;i++)armorLength.push(iarmor[i].length);if(-1!=lock)for(i=0;i<lock.length;i++)lock[i].length>0?lockBool.push(!0):lockBool.push(!1);else for(i=0;i<setWidth.length;i++)lockBool.push(!1);greenLight=!1,filtSetCells=[],filtSet=[],labelCount=0,search(indexPerk,indexPerkRank,lock),filtSetLength=filtSet.length,cacheSet=processFiltSetelem(filtSetCount),cacheSetLength=cacheSet.id.length,filtSetCount++,this.postMessage({set:{id:cacheSet.id[cacheSetCount],cell:cacheSet.cell}}),cacheSetCount++}-23==e.data&&(filtSetCount<filtSetLength&&setCount<100?cacheSetCount<cacheSetLength&&setCount<100?(this.postMessage({set:{id:cacheSet.id[cacheSetCount],cell:cacheSet.cell}}),cacheSetCount++,setCount++):(cacheSetCount=0,cacheSet=processFiltSetelem(filtSetCount),cacheSetLength=cacheSet.id.length-3,filtSetCount++,this.postMessage({set:{id:cacheSet.id[cacheSetCount],cell:cacheSet.cell}}),cacheSetCount++):self.close())};